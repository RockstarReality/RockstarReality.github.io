<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn Linux</title>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:monospace;display:flex;flex-direction:column;height:100vh;background:#1e1e1e;color:#eaeaea;}
#instructions{padding:0.8rem;background:#2b2b2b;min-height:14vh;max-height:20vh;overflow-y:auto;border-bottom:2px solid #444;white-space: pre-line;}
#terminal{flex:1;padding:0.75rem;background:#000;overflow-y:auto;font-size:0.9rem;line-height:1.4;}
#input-bar{display:flex;padding:0.5rem;background:#111;border-top:2px solid #333;}
#prompt{color:#00ff88;margin-right:0.3rem;}
#commandInput{flex:1;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:1rem;}
.success{color:#00ff88;}
.hint{color:#ffd866;}
.error{color:#ff5555;}
.dim{color:#888;}
@media(min-width:768px){
  body{flex-direction:row;}
  #instructions{width:40%;height:100vh;max-height:none;border-bottom:none;border-right:2px solid #444;}
  #terminal-container{width:60%;display:flex;flex-direction:column;height:100vh;}
}
</style>
</head>
<body>

<div id="instructions"></div>
<div id="terminal-container">
  <pre id="terminal"></pre>
  <div id="input-bar">
    <span id="prompt">$</span>
    <input id="commandInput" type="text" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" placeholder="type a commandâ€¦">
  </div>
</div>

<script>
// Global error catcher â€“ prints errors directly to terminal for easy copy-paste debugging on phone
window.addEventListener('error', function(e) {
  print("JS ERROR: " + e.message + " (around line " + e.lineno + ")", "error");
});

// =====================
// STATE & FILESYSTEM
// =====================
let cwd="/home/student", user="student";
let fs={"/":{home:{student:{"readme.txt":{content:"Welcome to Learn Linux.\nLinux rewards curiosity.",perm:"rw-r--r--",type:"text"},"script.sh":{content:"# /bin/bash\necho Hello",perm:"rw-------",type:"shell script"}}}}};
let state={lastCmd:"", testProgress:0, packages:[], mistakes:{}, training:false, trainingQueue:[], trainingIndex:0, hintCount:0,
           xp: 0, hearts: 5, streak: 0};  // Added gamification fields
let lessonIndex=0;
let debugMode = false;  // For extra debug output

// Load saved progress from localStorage
if (localStorage.getItem('learnLinuxProgress')) {
  const saved = JSON.parse(localStorage.getItem('learnLinuxProgress'));
  lessonIndex = saved.lessonIndex || 0;
  state.xp = saved.xp || 0;
  state.hearts = saved.hearts || 5;
  state.streak = saved.streak || 0;
}

// Save progress to localStorage
function saveProgress() {
  const data = {
    lessonIndex: lessonIndex,
    xp: state.xp,
    hearts: state.hearts,
    streak: state.streak
  };
  localStorage.setItem('learnLinuxProgress', JSON.stringify(data));
}

// Shuffle for training mode (was missing)
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// =====================
// LESSONS 1-6 (your original)
// =====================
const lessons=[
{ title:"Level 1.1 â€” Where am I?", text:"Show your current directory.", goal:()=>state.lastCmd==="pwd", hint:"pwd" },
{ title:"Level 1.2 â€” List files", text:"List the files in this directory.", goal:()=>state.lastCmd==="ls", hint:"ls" },
{ title:"Level 1.3 â€” Move around", text:"Change into root /.", goal:()=>cwd==="/", hint:"cd /" },
{ title:"Level 1.4 â€” Go back home", text:"Return to home.", goal:()=>cwd==="/home/student", hint:"cd /home/student" },
{ title:"Level 1.5 â€” Create a file", text:"Create notes.txt.", goal:()=>resolveDir(cwd)["notes.txt"], hint:"touch notes.txt" },
{ title:"Level 1.6 â€” Read a file", text:"Read readme.txt.", goal:()=>state.lastCmd==="cat readme.txt", hint:"cat readme.txt" },
{ title:"Level 2.1 â€” Who are you?", text:"Show your user.", goal:()=>state.lastCmd==="whoami", hint:"whoami" },
{ title:"Level 2.2 â€” Identity details", text:"Show UID/GID.", goal:()=>state.lastCmd==="id", hint:"id" },
{ title:"Level 2 Final Test", text:"Navigate, list, create/read files, show user.", goal:()=>state.testProgress>=5, hint:"Take one command at a time." },

{ title:"Level 3.1 â€” Long listing", text:"List files with details.", goal:()=>state.lastCmd==="ls -l", hint:"ls -l" },
{ title:"Level 3.2 â€” File type", text:"What is script.sh?", goal:()=>state.lastCmd==="file script.sh", hint:"file script.sh" },
{ title:"Level 3.3 â€” Make executable", text:"Make script.sh executable for you.", goal:()=>resolveDir(cwd)["script.sh"].perm.startsWith("rwx"), hint:"chmod u+x script.sh" },
{ title:"Level 3.4 â€” Locate command", text:"Where is ls?", goal:()=>state.lastCmd==="which ls", hint:"which ls" },
{ title:"Level 3 Final Test", text:"List permissions, file type, chmod, which command.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 4.1 â€” Download a file", text:"Simulate downloading a file using wget.", goal:()=>resolveDir(cwd)["downloaded.txt"], hint:"wget http://example.com/file.txt" },
{ title:"Level 4.2 â€” Use curl", text:"Simulate downloading another file with curl.", goal:()=>resolveDir(cwd)["curlfile.txt"], hint:"curl -O http://example.com/other.txt" },
{ title:"Level 4.3 â€” Verify download", text:"Check file type of downloaded.txt.", goal:()=>state.lastCmd==="file downloaded.txt", hint:"file downloaded.txt" },
{ title:"Level 4 Final Test", text:"Use wget, curl, check file type. Practice safe handling.", goal:()=>state.testProgress>=3, hint:"Step by step." },

{ title:"Level 5.1 â€” Update package list", text:"Update the system package list using apt update.", goal:()=>state.lastCmd==="apt update", hint:"apt update" },
{ title:"Level 5.2 â€” Install a package", text:"Install a package (simulate).", goal:()=>state.packages.includes("nano"), hint:"apt install nano" },
{ title:"Level 5.3 â€” List installed packages", text:"See installed packages with dpkg -l.", goal:()=>state.lastCmd==="dpkg -l", hint:"dpkg -l" },
{ title:"Level 5.4 â€” Upgrade packages", text:"Upgrade installed packages.", goal:()=>state.lastCmd==="apt upgrade", hint:"apt upgrade" },
{ title:"Level 5 Final Test", text:"Update, install, list packages, upgrade safely.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 6.1 â€” List processes", text:"Show running processes.", goal:()=>state.lastCmd==="ps aux", hint:"ps aux" },
{ title:"Level 6.2 â€” Check memory", text:"Show memory usage.", goal:()=>state.lastCmd==="free -h", hint:"free -h" },
{ title:"Level 6.3 â€” Disk usage", text:"Show disk usage.", goal:()=>state.lastCmd==="df -h", hint:"df -h" },
{ title:"Level 6.4 â€” Schedule a cron job", text:"Simulate adding a cron job.", goal:()=>state.lastCmd==="crontab -l", hint:"crontab -l" },
{ title:"Level 6.5 â€” Network info", text:"Check IP addresses.", goal:()=>state.lastCmd==="ip addr", hint:"ip addr" },
{ title:"Level 6 Final Test", text:"Processes, memory, disk, cron, network.", goal:()=>state.testProgress>=5, hint:"Step by step." }
];
// =====================
// UI ELEMENTS
// =====================
const instr = document.getElementById("instructions");
const term = document.getElementById("terminal");
const input = document.getElementById("commandInput");

function print(txt, cls="") {
    let d = document.createElement("div");
    d.textContent = txt;
    if(cls) d.className = cls;
    term.appendChild(d);
    term.scrollTop = term.scrollHeight;
}

// =====================
// FILESYSTEM HELPERS
// =====================
function resolveDir(path){
    let p = path.split("/").filter(Boolean);
    let c = fs["/"];
    for(let x of p){
        if(c[x] && typeof c[x]==="object") c = c[x];
        else return null;
    }
    return c;
}

function normalizePath(path){
    if(!path.startsWith("/")) path = cwd + "/" + path;
    let parts = path.split("/"), stack=[];
    for(let p of parts){
        if(!p||p===".") continue;
        else if(p==="..") stack.pop();
        else stack.push(p);
    }
    return "/" + stack.join("/");
}

// =====================
// LOAD LESSONS
// =====================
function loadLesson(){ 
    if(lessonIndex >= lessons.length){ 
        instr.textContent="ðŸŽ‰ Congratulations! You completed all lessons.";
        print("ðŸŽ‰ All levels complete! Great work!","success");
        return;
    }
    instr.textContent=`ðŸ“˜ \( {lessons[lessonIndex].title}\n\n \){lessons[lessonIndex].text}`;
    state.hearts = 5; // Refill hearts on new lesson
    state.hintCount=0;
    print(`Lesson \( {lessonIndex+1}: \){lessons[lessonIndex].title} started. â¤ï¸ ${state.hearts}`,`success`);
    if(!state.training && (lessonIndex===0 || Object.values(state.mistakes).some(v=>v>=2))){
        print("ðŸ’¡ Tip: Use `training` or `train` to practice weak commands.","hint");
    }
}

// =====================
// INPUT HANDLING
// =====================
input.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ 
        execute(input.value.trim()); 
        input.value=""; 
        input.focus(); 
        saveProgress(); 
    }
});
document.body.addEventListener("click",()=>input.focus());

// =====================
// COMMAND EXECUTION (with gamification)
// =====================
function execute(cmdline){
    state.lastCmd = cmdline;
    if(cmdline) print(`$ ${cmdline}`, "dim");
    let [cmd, ...args] = cmdline.split(" ");
    let arg = args.join(" ");

    let success = false;

    // Debug info if enabled
    if(debugMode) print(`[DEBUG] cmd=\( {cmd} | arg= \){arg} | hearts=\( {state.hearts} | streak= \){state.streak} | xp=${state.xp}`, "dim");

    // HELP
    if(cmd==="help"||cmdline.endsWith("-h")) 
        print("Commands:\npwd, ls, ls -l, cd, touch, cat, whoami, id, stat, chmod, file, which, wget, curl, apt update/install/upgrade, dpkg -l, ps aux, free -h, df -h, crontab -l, ip addr, nano, bash, hint, skip, training, train, status, debug on/off\nðŸ’¡ `train` starts practice mode.","hint");

    // STATUS (new diagnostic command)
    else if(cmd === "status") {
        let pct = Math.round((lessonIndex / lessons.length) * 100);
        print(`Progress: Lesson \( {lessonIndex+1}/ \){lessons.length} (\( {pct}%) | XP: \){state.xp} | â¤ï¸ \( {state.hearts}/5 | ðŸ”¥ Streak: \){state.streak}`, "hint");
    }

    // DEBUG toggle
    else if(cmd === "debug") {
        debugMode = arg === "on";
        print(`Debug mode ${debugMode ? "ON (extra info)" : "OFF"}`, debugMode ? "success" : "dim");
    }

    // HINT
    else if(cmd==="hint"){ 
        print(lessons[lessonIndex].hint,"hint"); 
        state.hintCount++; 
    }

    // NAVIGATION & FILES (your original)
    else if(cmd==="pwd") { print(cwd); success = true; }
    else if(cmd==="ls" && args[0]==="-l"){
        let dir = resolveDir(cwd);
        if(dir) Object.entries(dir).forEach(([n,f])=>print(`\( {f.perm} \){user} ${n}`));
        else print("No such directory","error");
        success = true;
    }
    else if(cmd==="ls"){
        let dir = resolveDir(cwd);
        if(dir) print(Object.keys(dir).join(" "));
        else print("No such directory","error");
        success = true;
    }
    else if(cmd==="cd"){ 
        let target = normalizePath(arg||"/");
        if(resolveDir(target)) { cwd=target; success = true; }
        else print("No such directory","error");
    }
    else if(cmd==="touch"){ 
        let dir = resolveDir(cwd);
        if(dir && arg) dir[arg]={content:"",perm:"rw-r--r--",type:"text"}; 
        print("File created"); 
        success = true;
    }
    else if(cmd==="cat"){ 
        let dir = resolveDir(cwd);
        let f = dir ? dir[arg] : null;
        if(f && f.content!==undefined) print(f.content);
        else print("No such file","error"); 
        success = true;
    }

    // TRACK LESSON PROGRESS + GAMIFICATION
    if(lessons[lessonIndex]?.goal && lessons[lessonIndex].goal()){
        success = true;
        state.testProgress++;
        let xpGain = lessons[lessonIndex].title.includes("Final") ? 20 : 10;
        state.xp += xpGain;
        state.streak++;
        print(`Correct! +\( {xpGain} XP ðŸŽ‰ | Streak: \){state.streak} ðŸ”¥`, "success");

        if(!lessons[lessonIndex].title.includes("Final") && !state.training){ 
            lessonIndex++; 
            state.testProgress=0; 
            loadLesson(); 
        } else if(lessons[lessonIndex].title.includes("Final") && state.testProgress>=5){ 
            lessonIndex++; 
            state.testProgress=0; 
            print("ðŸŽ‰ Final complete! Moving on.","success");
            if(lessonIndex<lessons.length) loadLesson();
        }
    }

    // Mistake handling (lose heart if active lesson and not training)
    if(!success && cmd && !["help","status","debug","hint"].includes(cmd) && !state.training){
        if(state.hearts > 0){
            state.hearts--;
            print(`Mistake! -1 â¤ï¸ (${state.hearts} left) ðŸ˜”`, "error");
        }
        state.streak = 0;
    }

    // TRAINING MODE
    if(state.training){
        let current = state.trainingQueue[state.trainingIndex];
        if(current && current.goal()){ 
            state.trainingIndex++; 
            loadTrainingLesson(); 
        }
    }

    saveProgress();
}

// =====================
// TRAINING MODE FIXED
// =====================
function startTraining(){
    state.training=true;
    let candidates = lessons.filter(l=>!l.title.includes("Final") && (state.mistakes[l.hint] || lessonIndex <= lessons.indexOf(l)));
    state.trainingQueue=[];
    for(let l of candidates){
        let weight = Math.max(1,(state.mistakes[l.hint]||0));
        for(let i=0;i<weight;i++) state.trainingQueue.push(l);
    }
    shuffle(state.trainingQueue);
    state.trainingIndex=0;
    print("ðŸŽ¯ Training session started!","hint");
    loadTrainingLesson();
}
function loadTrainingLesson(){
    if(state.trainingIndex>=state.trainingQueue.length){ 
        print("ðŸŽ‰ Training complete!","success"); 
        state.training=false; 
        loadLesson(); 
        return; 
    }
    let l=state.trainingQueue[state.trainingIndex];
    instr.textContent=`ðŸŽ¯ Training: \( {l.title}\n\n \){l.text}`;
}

// =====================
// LESSONS 7-10 (Advanced) - your original push
// =====================
lessons.push(
{ title:"Level 7.1 â€” Loops in scripts", text:"Add a for loop in script.sh that prints numbers 1-5.", goal:()=>resolveDir(cwd)["script.sh"].content.includes("for"), hint:"for i in 1 2 3 4 5; do echo $i; done" },
{ title:"Level 7.2 â€” Variables", text:"Use a variable in script.sh to store a message and echo it.", goal:()=>resolveDir(cwd)["script.sh"].content.includes("msg="), hint:"msg='Hello'; echo $msg" },
{ title:"ðŸ§ª Level 7 Final Test", text:"Write a script using a loop and variable. Run it.", goal:()=>state.testProgress>=2, hint:"Step by step." },

{ title:"Level 8.1 â€” Redirection", text:"Redirect output of echo 'Hello' to hello.txt.", goal:()=>resolveDir(cwd)["hello.txt"], hint:"echo 'Hello' > hello.txt" },
{ title:"Level 8.2 â€” Pipes", text:"Pipe output of echo 'one two three' to grep 'two'.", goal:()=>state.lastCmd==="echo 'one two three' | grep 'two'", hint:"Use | grep" },
{ title:"Level 8.3 â€” Filters", text:"Use awk to print the first column of a text file.", goal:()=>state.lastCmd.startsWith("awk"), hint:"awk '{print $1}' file.txt" },
{ title:"ðŸ§ª Level 8 Final Test", text:"Use redirection, pipes, and filters on sample text.", goal:()=>state.testProgress>=3, hint:"Try one at a time." },

{ title:"Level 9.1 â€” File ownership", text:"Simulate changing ownership of notes.txt to another user.", goal:()=>state.lastCmd==="chown user:group notes.txt", hint:"chown user:group notes.txt" },
{ title:"Level 9.2 â€” Permissions review", text:"Check permissions and explain meaning.", goal:()=>state.lastCmd==="stat notes.txt", hint:"stat notes.txt" },
{ title:"Level 9.3 â€” Sudo simulation", text:"Run a command with elevated privileges.", goal:()=>state.lastCmd.startsWith("sudo"), hint:"sudo ls /root" },
{ title:"Level 9.4 â€” Network commands", text:"Ping 127.0.0.1 and check network info.", goal:()=>state.lastCmd==="ping 127.0.0.1" || state.lastCmd==="ip addr", hint:"ping, ip addr" },
{ title:"ðŸ§ª Level 9 Final Test", text:"Ownership, permissions, sudo, networking.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 10.1 â€” Cron automation", text:"Add a simulated cron job to run script.sh every minute.", goal:()=>state.lastCmd==="crontab -l", hint:"crontab -e" },
{ title:"Level 10.2 â€” Monitoring", text:"Check running processes and memory.", goal:()=>state.lastCmd==="ps aux" && state.lastCmd==="free -h", hint:"ps aux, free -h" },
{ title:"Level 10.3 â€” Combining commands", text:"Use pipe and redirection together.", goal:()=>state.lastCmd.includes("|") && state.lastCmd.includes(">"), hint:"cat file.txt | grep 'pattern' > out.txt" },
{ title:"ðŸ§ª Level 10 Final Test", text:"Simulate sysadmin tasks, monitoring, cron, pipes, redirection.", goal:()=>state.testProgress>=3, hint:"Follow carefully." }
);

// =====================
// MOBILE & UX ENHANCEMENTS
// =====================
function resizeTerminal(){
    let h = window.innerHeight - instr.offsetHeight - input.parentElement.offsetHeight - 20;
    term.style.height = h+"px";
}
window.addEventListener("resize", resizeTerminal);
resizeTerminal();
input.focus(); // auto-focus input on load

print("ðŸ“± Mobile-ready: input focused, terminal auto-scroll, instructions adjust height.");
print("Welcome back! Type 'status' for progress or 'help' for commands.","success");

// START THE GAME
loadLesson();

// =====================
// FINALIZE HTML
// =====================
</script>
</body>
</html>
