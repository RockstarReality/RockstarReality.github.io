<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn Linux</title>
<style>
*{box-sizing:border-box;}
body{margin:0;font-family:monospace;display:flex;flex-direction:column;height:100vh;background:#1e1e1e;color:#eaeaea;}
#instructions{padding:0.8rem;background:#2b2b2b;min-height:14vh;max-height:20vh;overflow-y:auto;border-bottom:2px solid #444;white-space: pre-line;}
#terminal{flex:1;padding:0.75rem;background:#000;overflow-y:auto;font-size:0.9rem;line-height:1.4;}
#input-bar{display:flex;padding:0.5rem;background:#111;border-top:2px solid #333;}
#prompt{color:#00ff88;margin-right:0.3rem;}
#commandInput{flex:1;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:1rem;}
.success{color:#00ff88;}
.hint{color:#ffd866;}
.error{color:#ff5555;}
.dim{color:#888;}
@media(min-width:768px){
  body{flex-direction:row;}
  #instructions{width:40%;height:100vh;max-height:none;border-bottom:none;border-right:2px solid #444;}
  #terminal-container{width:60%;display:flex;flex-direction:column;height:100vh;}
}
</style>
</head>
<body>

<div id="instructions"></div>
<div id="terminal-container">
  <pre id="terminal"></pre>
  <div id="input-bar">
    <span id="prompt">$</span>
    <input id="commandInput" type="text" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" placeholder="type a command‚Ä¶">
  </div>
</div>

<script>
// =====================
// STATE & FILESYSTEM
// =====================
let cwd="/home/student", user="student";
let fs={"/":{home:{student:{"readme.txt":{content:"Welcome to Learn Linux.\nLinux rewards curiosity.",perm:"rw-r--r--",type:"text"},"script.sh":{content:"# /bin/bash\necho Hello",perm:"rw-------",type:"shell script"}}}}};
let state={lastCmd:"", testProgress:0, packages:[], mistakes:{}, training:false, trainingQueue:[], trainingIndex:0, hintCount:0};

// =====================
// SHUFFLE FUNCTION
// =====================
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// =====================
// LESSONS
// =====================
let lessonIndex=0;
const lessons=[
{ title:"Level 1.1 ‚Äî Where am I?", text:"Show your current directory.", goal:()=>state.lastCmd==="pwd", hint:"pwd" },
{ title:"Level 1.2 ‚Äî List files", text:"List the files in this directory.", goal:()=>state.lastCmd==="ls", hint:"ls" },
{ title:"Level 1.3 ‚Äî Move around", text:"Change into root /.", goal:()=>cwd==="/", hint:"cd /" },
{ title:"Level 1.4 ‚Äî Go back home", text:"Return to home.", goal:()=>cwd==="/home/student", hint:"cd /home/student" },
{ title:"Level 1.5 ‚Äî Create a file", text:"Create notes.txt.", goal:()=>resolveDir(cwd)["notes.txt"], hint:"touch notes.txt" },
{ title:"Level 1.6 ‚Äî Read a file", text:"Read readme.txt.", goal:()=>state.lastCmd==="cat readme.txt", hint:"cat readme.txt" },
{ title:"Level 2.1 ‚Äî Who are you?", text:"Show your user.", goal:()=>state.lastCmd==="whoami", hint:"whoami" },
{ title:"Level 2.2 ‚Äî Identity details", text:"Show UID/GID.", goal:()=>state.lastCmd==="id", hint:"id" },
{ title:"Level 2 Final Test", text:"Navigate, list, create/read files, show user.", goal:()=>state.testProgress>=5, hint:"Take one command at a time." },

{ title:"Level 3.1 ‚Äî Long listing", text:"List files with details.", goal:()=>state.lastCmd==="ls -l", hint:"ls -l" },
{ title:"Level 3.2 ‚Äî File type", text:"What is script.sh?", goal:()=>state.lastCmd==="file script.sh", hint:"file script.sh" },
{ title:"Level 3.3 ‚Äî Make executable", text:"Make script.sh executable for you.", goal:()=>resolveDir(cwd)["script.sh"].perm.startsWith("rwx"), hint:"chmod u+x script.sh" },
{ title:"Level 3.4 ‚Äî Locate command", text:"Where is ls?", goal:()=>state.lastCmd==="which ls", hint:"which ls" },
{ title:"Level 3 Final Test", text:"List permissions, file type, chmod, which command.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 4.1 ‚Äî Download a file", text:"Simulate downloading a file using wget.", goal:()=>resolveDir(cwd)["downloaded.txt"], hint:"wget http://example.com/file.txt" },
{ title:"Level 4.2 ‚Äî Use curl", text:"Simulate downloading another file with curl.", goal:()=>resolveDir(cwd)["curlfile.txt"], hint:"curl -O http://example.com/other.txt" },
{ title:"Level 4.3 ‚Äî Verify download", text:"Check file type of downloaded.txt.", goal:()=>state.lastCmd==="file downloaded.txt", hint:"file downloaded.txt" },
{ title:"Level 4 Final Test", text:"Use wget, curl, check file type.", goal:()=>state.testProgress>=3, hint:"Step by step." },

{ title:"Level 5.1 ‚Äî Update package list", text:"Update the system package list using apt update.", goal:()=>state.lastCmd==="apt update", hint:"apt update" },
{ title:"Level 5.2 ‚Äî Install a package", text:"Install a package (simulate).", goal:()=>state.packages.includes("nano"), hint:"apt install nano" },
{ title:"Level 5.3 ‚Äî List installed packages", text:"See installed packages with dpkg -l.", goal:()=>state.lastCmd==="dpkg -l", hint:"dpkg -l" },
{ title:"Level 5.4 ‚Äî Upgrade packages", text:"Upgrade installed packages.", goal:()=>state.lastCmd==="apt upgrade", hint:"apt upgrade" },
{ title:"Level 5 Final Test", text:"Update, install, list packages, upgrade safely.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 6.1 ‚Äî List processes", text:"Show running processes.", goal:()=>state.lastCmd==="ps aux", hint:"ps aux" },
{ title:"Level 6.2 ‚Äî Check memory", text:"Show memory usage.", goal:()=>state.lastCmd==="free -h", hint:"free -h" },
{ title:"Level 6.3 ‚Äî Disk usage", text:"Show disk usage.", goal:()=>state.lastCmd==="df -h", hint:"df -h" },
{ title:"Level 6.4 ‚Äî Schedule a cron job", text:"Simulate adding a cron job.", goal:()=>state.lastCmd==="crontab -l", hint:"crontab -l" },
{ title:"Level 6.5 ‚Äî Network info", text:"Check IP addresses.", goal:()=>state.lastCmd==="ip addr", hint:"ip addr" },
{ title:"Level 6 Final Test", text:"Processes, memory, disk, cron, network.", goal:()=>state.testProgress>=5, hint:"Step by step." },

{ title:"Level 7.1 ‚Äî Loops in scripts", text:"Add a for loop in script.sh that prints numbers 1-5.", goal:()=>resolveDir(cwd)["script.sh"].content.includes("for"), hint:"for i in 1 2 3 4 5; do echo $i; done" },
{ title:"Level 7.2 ‚Äî Variables", text:"Use a variable in script.sh to store a message and echo it.", goal:()=>resolveDir(cwd)["script.sh"].content.includes("msg="), hint:"msg='Hello'; echo $msg" },
{ title:"üß™ Level 7 Final Test", text:"Write a script using a loop and variable. Run it.", goal:()=>state.testProgress>=2, hint:"Step by step." },

{ title:"Level 8.1 ‚Äî Redirection", text:"Redirect output of echo 'Hello' to hello.txt.", goal:()=>resolveDir(cwd)["hello.txt"], hint:"echo 'Hello' > hello.txt" },
{ title:"Level 8.2 ‚Äî Pipes", text:"Pipe output of echo 'one two three' to grep 'two'.", goal:()=>state.lastCmd==="echo 'one two three' | grep 'two'", hint:"Use | grep" },
{ title:"Level 8.3 ‚Äî Filters", text:"Use awk to print the first column of a text file.", goal:()=>state.lastCmd.startsWith("awk"), hint:"awk '{print $1}' file.txt" },
{ title:"üß™ Level 8 Final Test", text:"Use redirection, pipes, and filters on sample text.", goal:()=>state.testProgress>=3, hint:"Try one at a time." },

{ title:"Level 9.1 ‚Äî File ownership", text:"Simulate changing ownership of notes.txt to another user.", goal:()=>state.lastCmd==="chown user:group notes.txt", hint:"chown user:group notes.txt" },
{ title:"Level 9.2 ‚Äî Permissions review", text:"Check permissions and explain meaning.", goal:()=>state.lastCmd==="stat notes.txt", hint:"stat notes.txt" },
{ title:"Level 9.3 ‚Äî Sudo simulation", text:"Run a command with elevated privileges.", goal:()=>state.lastCmd.startsWith("sudo"), hint:"sudo ls /root" },
{ title:"Level 9.4 ‚Äî Network commands", text:"Ping 127.0.0.1 and check network info.", goal:()=>state.lastCmd==="ping 127.0.0.1" || state.lastCmd==="ip addr", hint:"ping, ip addr" },
{ title:"üß™ Level 9 Final Test", text:"Ownership, permissions, sudo, networking.", goal:()=>state.testProgress>=4, hint:"Step by step." },

{ title:"Level 10.1 ‚Äî Cron automation", text:"Add a simulated cron job to run script.sh every minute.", goal:()=>state.lastCmd==="crontab -l", hint:"crontab -e" },
{ title:"Level 10.2 ‚Äî Monitoring", text:"Check running processes and memory.", goal:()=>state.lastCmd==="ps aux" && state.lastCmd==="free -h", hint:"ps aux, free -h" },
{ title:"Level 10.3 ‚Äî Combining commands", text:"Use pipe and redirection together.", goal:()=>state.lastCmd.includes("|") && state.lastCmd.includes(">"), hint:"cat file.txt | grep 'pattern' > out.txt" },
{ title:"üß™ Level 10 Final Test", text:"Simulate sysadmin tasks, monitoring, cron, pipes, redirection.", goal:()=>state.testProgress>=3, hint:"Follow carefully." }
];

// =====================
// UI ELEMENTS
// =====================
const instr = document.getElementById("instructions");
const term = document.getElementById("terminal");
const input = document.getElementById("commandInput");

function print(txt, cls="") {
    let d = document.createElement("div");
    d.textContent = txt;
    if(cls) d.className = cls;
    term.appendChild(d);
    term.scrollTop = term.scrollHeight;
}

// =====================
// FILESYSTEM HELPERS
// =====================
function resolveDir(path){
    let p = path.split("/").filter(Boolean);
    let c = fs["/"];
    for(let x of p){
        if(c[x] && typeof c[x]==="object") c = c[x];
        else return null;
    }
    return c;
}

function normalizePath(path){
    if(!path.startsWith("/")) path = cwd + "/" + path;
    let parts = path.split("/"), stack=[];
    for(let p of parts){
        if(!p||p===".") continue;
        else if(p==="..") stack.pop();
        else stack.push(p);
    }
    return "/" + stack.join("/");
}

// =====================
// LOAD LESSON ‚Äì FIXED WITH BACKTICKS
// =====================
function loadLesson(){ 
    if(lessonIndex >= lessons.length){ 
        instr.textContent = "üéâ Congratulations! You completed all lessons.";
        return;
    }
    const title = lessons[lessonIndex]?.title || "(missing title)";
    const text  = lessons[lessonIndex]?.text  || "(missing instructions)";
    instr.textContent = `üìò \( {title}\n\n \){text}`;
    state.hintCount = 0;
    if(!state.training && (lessonIndex===0 || Object.values(state.mistakes).some(v=>v>=2))){
        print("üí° Tip: Use `training` or `train` anytime to practice weak commands.","hint");
    }
}

// =====================
// TRAINING MODE
// =====================
function startTraining(){
    state.training=true;
    let candidates = lessons.filter(l=>!l.title.includes("Final") && (state.mistakes[l.hint] || lessonIndex <= lessons.indexOf(l)));
    state.trainingQueue=[];
    for(let l of candidates){
        let weight = Math.max(1,(state.mistakes[l.hint]||0));
        for(let i=0;i<weight;i++) state.trainingQueue.push(l);
    }
    shuffle(state.trainingQueue);
    state.trainingIndex=0;
    print("üéØ Training session started! Type commands to practice.","hint");
    loadTrainingLesson();
}
function loadTrainingLesson(){
    if(state.trainingIndex>=state.trainingQueue.length){ 
        print("üéâ Training complete! Back to normal lessons.","success"); 
        state.training=false; 
        loadLesson(); 
        return; 
    }
    let l=state.trainingQueue[state.trainingIndex];
    instr.textContent=`üéØ Training: \( {l.title}\n\n \){l.text}`;
}

// =====================
// INPUT HANDLING
// =====================
input.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ 
        execute(input.value.trim()); 
        input.value=""; 
        input.focus(); 
    }
});
document.body.addEventListener("click",()=>input.focus());

// =====================
// COMMAND EXECUTION (unchanged from last working version)
// =====================
function execute(cmdline){
    if(!cmdline) return;
    state.lastCmd = cmdline;
    print(`$ ${cmdline}`, "dim");

    let parts = cmdline.split(" ");
    let cmd = parts[0];
    let arg = parts.slice(1).join(" ");

    if(lessons[lessonIndex]?.title.includes("Final")){
        if(cmd && !["help","hint","skip","training","train","levels","menu","goto","go","jump"].includes(cmd)){
            state.testProgress++;
        }
    }

    if(cmd==="help"||cmdline.endsWith("-h")) {
        print("Commands: pwd ls ls -l cd touch cat whoami id chmod file which wget curl apt update/install/upgrade dpkg -l ps aux free -h df -h crontab -l ip addr echo > nano bash script.sh\nSpecial: hint, skip [N], levels/menu, goto N / go N / jump N, training/train","hint");
    }
    else if(cmd==="hint"){ 
        print(lessons[lessonIndex].hint,"hint"); 
        state.hintCount++; 
    }
    else if(cmd==="skip"){
        let steps = (arg && !isNaN(parseInt(arg))) ? parseInt(arg) : 1;
        let skipped = 0;
        for(let i = 0; i < steps && lessonIndex < lessons.length - 1; i++){
            lessonIndex++;
            skipped++;
        }
        state.testProgress = 0;
        state.hintCount = 0;
        if(skipped > 0){
            print(`‚è≠ Skipped \( {skipped} lesson(s). Now at: \){lessons[lessonIndex].title}`,"hint");
            if(lessonIndex < lessons.length) loadLesson();
            else instr.textContent = "üéâ You've skipped to the end!";
        } else {
            print("Nothing left to skip.","dim");
        }
    }
    else if(cmd==="levels" || cmd==="menu"){
        let output = "üìã Available Lessons:\n";
        lessons.forEach((l,i) => {
            let marker = (i === lessonIndex) ? " ‚Üê CURRENT" : "";
            output += `\( {i+1}. \){l.title}${marker}\n`;
        });
        print(output.trim(),"hint");
    }
    else if(cmd==="goto" || cmd==="go" || cmd==="jump"){
        let target = parseInt(arg);
        if(!isNaN(target) && target >=1 && target <= lessons.length){
            lessonIndex = target - 1;
            state.testProgress = 0;
            state.hintCount = 0;
            print(`‚úÖ Jumped to lesson \( {target}: \){lessons[lessonIndex].title}`,"success");
            loadLesson();
        } else {
            print(`Invalid number. Use 'levels' to see list (1-${lessons.length})`,"error");
        }
    }
    else if(cmd==="training" || cmd==="train"){
        startTraining();
    }
    else if(cmd==="pwd") print(cwd);
    else if(cmd==="ls" && arg==="-l"){
        let dir = resolveDir(cwd);
        if(dir) Object.entries(dir).forEach(([n,f])=>print(`\( {f.perm} \){user} ${n}`));
        else print("No such directory","error");
    }
    else if(cmd==="ls"){
        let dir = resolveDir(cwd);
        if(dir) print(Object.keys(dir).join(" "));
        else print("No such directory","error");
    }
    else if(cmd==="cd"){ 
        let target = normalizePath(arg||"/");
        if(resolveDir(target)) cwd=target;
        else print("No such directory","error");
    }
    else if(cmd==="touch"){ 
        let dir = resolveDir(cwd);
        if(dir && arg) dir[arg]={content:"",perm:"rw-r--r--",type:"text"}; 
        print("File created"); 
    }
    else if(cmd==="cat"){ 
        let dir = resolveDir(cwd);
        let f = dir ? dir[arg] : null;
        if(f && f.content!==undefined) print(f.content);
        else print("No such file","error"); 
    }
    else if(cmd==="echo"){
        if(arg.includes(">")){
            let parts = arg.split(">",2);
            let content = parts[0].trim().replace(/^["']|["']$/g,"");
            let filename = parts[1].trim();
            let dir = resolveDir(cwd);
            if(dir && filename){
                dir[filename] = {content, perm:"rw-r--r--", type:"text"};
                print(`Written to ${filename}`);
            }
        } else {
            print(arg || "");
        }
    }
    else if(cmd==="bash" || cmd.endsWith(".sh")){
        let scriptName = cmd.endsWith(".sh") ? cmd : arg;
        let dir = resolveDir(cwd);
        let f = dir ? dir[scriptName] : null;
        if(f && f.content){
            print(`Running ${scriptName} (simulated)...`);
            if(f.content.includes("echo")){
                let matches = f.content.match(/echo\s+["']?([^"'\n]+)/g);
                if(matches) matches.forEach(m => print(m.replace(/echo\s+["']?/, "")));
            } else {
                print("Script completed successfully.");
            }
        } else print("No such script","error");
    }
    else if(cmd==="nano"){
        print("nano: Full editing not supported. Use 'echo \"content\" > filename' instead.","hint");
    }

    // Progress for regular lessons
    if(lessons[lessonIndex]?.goal && lessons[lessonIndex].goal()){
        state.testProgress++;
        if(!lessons[lessonIndex].title.includes("Final")){
            lessonIndex++;
            state.testProgress=0;
            loadLesson();
        } else if(state.testProgress >= 3){
            print("üéâ Final test complete! Moving on.","success");
            lessonIndex++;
            state.testProgress=0;
            if(lessonIndex < lessons.length) loadLesson();
        }
    }

    if(state.training){
        let current = state.trainingQueue[state.trainingIndex];
        if(current && current.goal()){
            state.trainingIndex++;
            loadTrainingLesson();
        }
    }
}

// =====================
// STARTUP
// =====================
print("üì± Welcome to Learn Linux Terminal Trainer","success");
print("Type 'help' anytime. Type 'levels' to jump around lessons.","hint");
loadLesson();
input.focus();
</script>
</body>
</html>
